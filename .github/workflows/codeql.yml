name: Gitleaks Secret Scanning

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  scan-secrets:
    name: Scan for Secrets with Gitleaks
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Gitleaks using Chocolatey
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install gitleaks -y --no-progress

      - name: Verify Gitleaks Installation
        run: gitleaks version

      - name: Run Gitleaks Secret Scan
        run: gitleaks detect --source . --report-format=sarif --report-path=gitleaks.sarif || echo "Gitleaks scan completed with issues"

      - name: Debug SARIF Report
        run: |
          if (Test-Path "gitleaks.sarif") {
            echo "SARIF report generated successfully:"
            Get-Content gitleaks.sarif
          } else {
            echo "‚ùå SARIF report NOT found!"
            exit 1
          }

      - name: Upload SARIF Report to GitHub Security Alerts
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gitleaks.sarif
