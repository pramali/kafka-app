name: Secret Scanning with Gitleaks on Windows

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  scan-secrets:
    name: Scan for Secrets with Gitleaks on Windows
    runs-on: windows-latest  # Windows runner

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Gitleaks for Windows
        run: |
          # Download the latest Gitleaks release for Windows
          Invoke-WebRequest -Uri "https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-windows-amd64.exe" -OutFile "gitleaks.exe"
          
          # Check if Gitleaks is downloaded successfully
          if (!(Test-Path -Path ".\gitleaks.exe")) {
            Write-Error "Gitleaks download failed"
            exit 1
          }

      - name: Run Gitleaks Secret Scan
        run: |
          # Run the Gitleaks scan and output to SARIF format
          .\gitleaks.exe detect --report-format=sarif --report-path=gitleaks.sarif || echo "Gitleaks scan completed with issues"

      - name: Upload SARIF Report to GitHub Security Alerts
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gitleaks.sarif
