name: Secret Scanning with TruffleHog (Windows)

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  secret-scan:
    runs-on: windows-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python and TruffleHog
        shell: pwsh
        run: |
          # Install Python
          Invoke-WebRequest -Uri https://www.python.org/ftp/python/3.8.8/python-3.8.8-amd64.exe -OutFile python-installer.exe
          Start-Process -FilePath python-installer.exe -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait
          $env:Path += ";C:\Python38\Scripts\;C:\Python38\"
          python --version

          # Upgrade pip and install TruffleHog
          python -m pip install --upgrade pip
          pip install --upgrade trufflehog
          
          # Verify installation
          trufflehog --version

      - name: Run TruffleHog and Generate SARIF
        shell: pwsh
        run: |
          # Run TruffleHog and output results in JSON
          trufflehog filesystem . --json | Out-File -Encoding utf8 trufflehog_output.json
          
          # Convert JSON to SARIF
          python -c "
          import json
          sarif = {
              'version': '2.1.0',
              'runs': [{
                  'tool': {'driver': {'name': 'TruffleHog'}},
                  'results': [
                      {'message': {'text': f'Potential secret: {issue}'}}
                      for issue in json.load(open('trufflehog_output.json', encoding='utf-8'))
                  ]
              }]
          }
          json.dump(sarif, open('trufflehog_output.sarif', 'w', encoding='utf-8'))
          "

      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trufflehog_output.sarif  # âœ… Correct path
