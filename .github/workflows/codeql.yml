name: Secret Scanning with Gitleaks on Windows

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  scan-secrets:
    name: Scan for Secrets with Gitleaks on Windows
    runs-on: windows-latest  # Windows runner

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Gitleaks on Windows
        run: |
          # Download the latest Gitleaks release for Windows
          Invoke-WebRequest -Uri "https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-windows-amd64.exe" -OutFile "gitleaks.exe"
          
          # Verify if file is downloaded successfully
          if (!(Test-Path gitleaks.exe)) {
            Write-Error "Gitleaks download failed"
            exit 1
          }
          
          # Add the Gitleaks binary to PATH
          $env:Path += ";$(pwd)"
          
          # Test Gitleaks version to confirm installation
          .\gitleaks.exe version

      - name: Run Gitleaks Secret Scan
        run: |
          # Run Gitleaks scan with SARIF output
          .\gitleaks.exe detect --report-format=sarif --report-path=gitleaks.sarif --no-git || echo "Gitleaks scan completed with issues"

      - name: Upload SARIF Report to GitHub Security Alerts
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gitleaks.sarif
