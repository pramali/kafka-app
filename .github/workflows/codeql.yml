name: Secret Scanning with TruffleHog (Windows)

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  secret-scan:
    runs-on: windows-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and Install TruffleHog from GitHub
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog-windows-amd64.exe" -OutFile "trufflehog.exe"
          echo "TruffleHog installed successfully"

      - name: Run TruffleHog and generate SARIF
        shell: pwsh
        run: |
          .\trufflehog.exe filesystem . --json | Out-File -Encoding utf8 trufflehog_output.json
          python -c "
          import json
          def convert_to_sarif(input_file, output_file):
              data = json.load(open(input_file, encoding='utf-8'))
              sarif = {
                  'version': '2.1.0',
                  'runs': [{
                      'tool': {'driver': {'name': 'TruffleHog'}},
                      'results': [
                          {'message': {'text': f'Potential secret: {issue}'}}
                          for issue in data
                      ]
                  }]
              }
              json.dump(sarif, open(output_file, 'w', encoding='utf-8'))
          convert_to_sarif('trufflehog_output.json', 'trufflehog_output.sarif')"

      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trufflehog_output.sarif
